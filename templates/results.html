<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pest &amp; Disease Results â€“ {{ field_id }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  </head>
  <body class="app-body">
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-md-3">
          <a class="navbar-brand fw-bold" href="/">ðŸª² Pest &amp; Disease Early Warning</a>
          <span class="navbar-text text-white small">
            Field: {{ field_id }} â€¢ Crop: {{ crop_type }}
          </span>
        </div>

        <a
          class="back-to-portal"
          href="https://agroverse-portal.netlify.app/?feature=2"
        >
          Back to Portal
        </a>
      </div>
    </nav>

    <div class="container main-shell mb-5">
      <div class="row mb-3">
        <div class="col-md-8">
          <h4>Risk Overview</h4>
          <p class="text-muted small mb-1">
            Location: ({{ "%.4f"|format(location.lat) }}, {{ "%.4f"|format(location.lon) }}) â€¢ Run at {{ timestamp }}
          </p>
          {% if notes_extension %}
          <p class="small mb-1"><strong>Extension data:</strong> {{ notes_extension }}</p>
          {% endif %}
          {% if notes_pest %}
          <p class="small mb-1"><strong>Farmer sightings:</strong> {{ notes_pest }}</p>
          {% endif %}
        </div>
        <div class="col-md-4 text-md-end mt-2 mt-md-0">
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">New analysis</a>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Pest &amp; Disease Risk Heatmap</h5>
              <img src="{{ url_for('static', filename=heatmap_path) }}" class="img-fluid rounded border" alt="Risk heatmap">
              <p class="small text-muted mt-2 mb-0">
                Darker red regions indicate higher inferred pest/disease risk from LAI/NDVI patterns and context.
              </p>
            </div>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Pest/Disease Risk Trend</h5>
              <img src="{{ url_for('static', filename=trend_path) }}" class="img-fluid rounded border" alt="Risk trend">
              <p class="small text-muted mt-2 mb-0">
                Derived risk index across the past time window. Rising values indicate increasing stress signals.
              </p>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Crop Outbreak Probabilities</h5>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Crop</th>
                      <th>Outbreak Probability</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for crop, prob in crop_outbreak_probs.items() %}
                    <tr>
                      <td>{{ crop }}</td>
                      <td>{{ "%.1f"|format(prob * 100) }}%</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <p class="small text-muted mb-0">
                These probabilities are inferred from the multimodal encoded state and should be combined
                with local agronomic knowledge.
              </p>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Key Indicators</h5>
              <ul class="list-unstyled small mb-2">
                <li><strong>Mean risk:</strong> {{ "%.3f"|format(mean_risk) }}</li>
                <li><strong>Max risk:</strong> {{ "%.3f"|format(max_risk) }}</li>
                <li><strong>Policy value:</strong> {{ "%.3f"|format(policy_value) }}</li>
              </ul>
              <div class="mb-2">
                <span class="badge bg-danger-subtle text-danger-emphasis border border-danger-subtle">
                  {{ timing_recommendation }}
                </span>
              </div>
              <p class="small text-muted mb-1">
                Timing recommendation from the Dreamer-style intervention policy head.
              </p>
            </div>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h6 class="card-title mb-2">Alerts</h6>
              {% for a in alerts %}
                <div class="alert alert-warning py-2 px-3 small mb-2">
                  {{ a }}
                </div>
              {% endfor %}

              <h6 class="card-title mb-2 mt-3">Likely Species &amp; Risk Levels</h6>
              <ul class="small mb-0">
                {% for sa in species_alerts %}
                <li>
                  <strong>{{ sa.species }}</strong> â€“ {{ sa.alert_level }}
                  (score {{ "%.2f"|format(sa.risk_score) }})
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h6 class="card-title mb-2">Suggested Control Measures</h6>
              <ul class="small mb-0">
                {% for c in control_measures %}
                <li>{{ c|safe }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h6 class="card-title mb-2">Policy Probabilities</h6>
              <p class="small text-muted mb-1">Probability over intervention timing options.</p>
              {% set actions = [
                "Intervene immediately in high-risk zones.",
                "Schedule intervention within 3 days.",
                "Increase monitoring; defer intervention for now.",
                "Risk currently low; maintain routine scouting only."
              ] %}
              <ol class="small mb-0">
                {% for prob in policy_probs %}
                  <li>{{ actions[loop.index0] }} â€“ {{ "%.1f"|format(prob * 100) }}%</li>
                {% endfor %}
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    </script>
  </body>
</html>
